<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Order</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; padding: 20px; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); }
        h2 { margin-top: 0; }
        .card { background: var(--tg-theme-secondary-bg-color, #f5f5f5); padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        
        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ó—É–±/–ò–º–ø–ª–∞–Ω—Ç */
        .toggle-container { display: flex; margin-bottom: 10px; background: #ddd; border-radius: 8px; padding: 2px; }
        .toggle-btn { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 14px; }
        .toggle-btn.active { background: #fff; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        
        .hidden { display: none; }
        .btn { width: 100%; padding: 14px; background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
    
    <div class="card">
        <label>üõ† –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫–∞:</label>
        <select id="tech_select">
            <option value="" disabled selected>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
        </select>
    </div>

    <div class="card">
        <label>üë§ –§–ò–û –ü–∞—Ü–∏–µ–Ω—Ç–∞:</label>
        <input type="text" id="patient" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò.–ò.">
    </div>

    <div class="card">
        <label>ü¶∑ –ù–æ–º–µ—Ä –∑—É–±–∞:</label>
        <select id="tooth_number">
            <option value="11">11 (–í–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π —Ä–µ–∑–µ—Ü)</option>
            <option value="21">21 (–í–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —Ä–µ–∑–µ—Ü)</option>
            <option value="36">36 (–ù–∏–∂–Ω–∏–π –ª–µ–≤—ã–π –º–æ–ª—è—Ä)</option>
            <option value="46">46 (–ù–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π –º–æ–ª—è—Ä)</option>
            </select>

        <label style="margin-top:10px">–¢–∏–ø –æ–ø–æ—Ä—ã:</label>
        <div class="toggle-container">
            <div class="toggle-btn active" onclick="setMode('tooth')" id="btn-tooth">–ù–∞ –∑—É–±–µ</div>
            <div class="toggle-btn" onclick="setMode('implant')" id="btn-implant">–ù–∞ –∏–º–ø–ª–∞–Ω—Ç–µ</div>
        </div>

        <div id="block-tooth">
            <label>–ú–∞—Ç–µ—Ä–∏–∞–ª:</label>
            <select id="material">
                <option value="Zirconia">–î–∏–æ–∫—Å–∏–¥ —Ü–∏—Ä–∫–æ–Ω–∏—è</option>
                <option value="E-max">E-max (–ü—Ä–µ—Å—Å)</option>
                <option value="Metal">–ú–µ—Ç–∞–ª–ª–æ–∫–µ—Ä–∞–º–∏–∫–∞</option>
            </select>
            <label>–¶–≤–µ—Ç (Vita):</label>
            <input type="text" id="color" placeholder="A1, A2, BL3...">
        </div>

        <div id="block-implant" class="hidden">
            <label>–ë—Ä–µ–Ω–¥ –∏–º–ø–ª–∞–Ω—Ç–∞:</label>
            <input type="text" id="implant_brand" placeholder="Osstem, Nobel, Straumann...">
            <label>–¢–∏–ø —Ñ–∏–∫—Å–∞—Ü–∏–∏:</label>
            <select id="fixation">
                <option value="screw">–í–∏–Ω—Ç–æ–≤–∞—è</option>
                <option value="cement">–¶–µ–º–µ–Ω—Ç–Ω–∞—è</option>
            </select>
        </div>

        <label style="margin-top:10px">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
        <textarea id="comment" rows="2" placeholder="–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏..."></textarea>
    </div>

    <button class="btn" onclick="sendOrder()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let currentMode = 'tooth';

        // 1. –ü–∞—Ä—Å–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Ç–µ—Ö–Ω–∏–∫–æ–≤ –∏–∑ URL
        function loadTechnicians() {
            const params = new URLSearchParams(window.location.search);
            const techsRaw = params.get('techs');
            const select = document.getElementById('tech_select');
            
            if (techsRaw) {
                try {
                    const techs = JSON.parse(techsRaw);
                    select.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å
                    techs.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.id;
                        opt.text = t.name;
                        select.appendChild(opt);
                    });
                } catch (e) {
                    select.innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞</option>';
                }
            } else {
                select.innerHTML = '<option value="">–ù–µ—Ç —Ç–µ—Ö–Ω–∏–∫–æ–≤ (Demo)</option>';
                // –î–ª—è —Ç–µ—Å—Ç–∞, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –±–µ–∑ –±–æ—Ç–∞, –¥–æ–±–∞–≤–∏–º —Ñ–µ–π–∫
                const opt = document.createElement('option');
                opt.value = "12345"; opt.text = "Demo Tech";
                select.appendChild(opt);
            }
        }

        // 2. –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-tooth').classList.toggle('active', mode === 'tooth');
            document.getElementById('btn-implant').classList.toggle('active', mode === 'implant');
            
            if (mode === 'tooth') {
                document.getElementById('block-tooth').classList.remove('hidden');
                document.getElementById('block-implant').classList.add('hidden');
            } else {
                document.getElementById('block-tooth').classList.add('hidden');
                document.getElementById('block-implant').classList.remove('hidden');
            }
        }

        // 3. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
        function sendOrder() {
            const tech_id = document.getElementById('tech_select').value;
            const patient = document.getElementById('patient').value;
            const toothNum = document.getElementById('tooth_number').value;
            const comment = document.getElementById('comment').value;

            if (!tech_id || !patient) {
                tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫–∞ –∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∞—Ü–∏–µ–Ω—Ç–∞!");
                return;
            }

            let detail = {};
            if (currentMode === 'tooth') {
                detail = {
                    type: 'tooth',
                    material: document.getElementById('material').value,
                    color: document.getElementById('color').value
                };
            } else {
                detail = {
                    type: 'implant',
                    brand: document.getElementById('implant_brand').value,
                    fixation: document.getElementById('fixation').value
                };
            }

            const data = {
                tech_id: tech_id,
                patient: patient,
                teeth: [
                    { 
                        number: toothNum, 
                        ...detail, // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ (—Ü–≤–µ—Ç –∏–ª–∏ –±—Ä–µ–Ω–¥)
                        comment: comment 
                    }
                ]
            };

            tg.sendData(JSON.stringify(data));
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        loadTechnicians();
    </script>
</body>
</html>
